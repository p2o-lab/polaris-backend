---
kind: pipeline
name: default

platform:
  os: linux
  arch: amd64

steps:

- name: test-secrets
  image: alpine
  environment:
      TESTSECRET:
        from_secret: test_secret
  commands:
    - echo "test"
    - echo $TESTSECRET

- name: build
  image: node:8-jessie
  commands:
  - npm install
  - npm run-script apidoc build

- name: test
  image: node:8-jessie
  commands:
  - export LOGLEVEL=warn
  - npm test

- name: docker
  image: plugins/docker
  settings:
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      repo: p2olab/polaris-backend

- name: notify
  image: drillster/drone-email
  settings:
    from: "plt@mailbox.tu-dresden.de"
    host: mail.zih.tu-dresden.de
    password:
      from_secret: email_password
    username: plt
  when:
    status:
    - changed
    - failure

---
kind: secret
name: docker_password
data: B3JgA8XYA4zQbN-5BHvq-YyZK3_3lfns08_M-U67QISpBQ==

---
kind: secret
name: docker_username
data: U2Jx4g95lMIzwT4NqXF8LRxOe_YeTQitI0oDiC0_dt0koew=

---
kind: secret
name: email_password
data: OEDavC0OttFArAYM7t94t3PIhr8A1mYV5Wcu-2yeGUszwI5tPg==

---
kind: secret
name: test_secret
data: qqtFX1bxtKIGg6DSzx7RZiFqQcYaNu8Nur4f4ZxOZZQvZ8bX


---
kind: signature
hmac: 2aba039cd20c6d6bb683b53b18e7adb7968ed4e0d58db4cb5492259401656d85

...
